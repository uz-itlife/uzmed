<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Лекарства Узбекистана 2025 — Реестр №29 + Группы</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
      color: #333;
    }

    header {
      background: #27ae60;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 24px;
    }

    .container {
      max-width: 1300px;
      margin: 20px auto;
      padding: 10px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    input,
    select,
    button {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }

    input,
    select {
      border: 1px solid #ccc;
    }

    button {
      background: #27ae60;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #219653;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th {
      background: #27ae60;
      color: white;
      padding: 12px;
    }

    td {
      padding: 10px;
      border: 1px solid #ddd;
    }

    tr:nth-child(even) {
      background: #f8fff8;
    }

    .uzbek {
      background: #e8f5e8 !important;
    }

    .import {
      background: #f0f8ff !important;
    }

    .generic {
      background: #fffacd !important;
      color: #b8860b;
    }

    .original {
      background: #e6f3ff !important;
      color: #0066cc;
    }

    .stats {
      font-size: 20px;
      font-weight: bold;
      padding: 15px;
      margin: 20px 0;
      border-radius: 10px;
      text-align: center;
      background: #d4edda;
      color: #155724;
    }

  /* Подсказка строго над текстом — красиво и аккуратно */
.tooltip {
  position: relative;
  cursor: help;
  display: inline-block;
}

.tooltip .tiptext {
  visibility: hidden;
  background-color: #1a1a1a;
  color: white;
  text-align: center;
  border-radius: 8px;
  padding: 10px 14px;
  font-size: 14px;
  font-weight: normal;

  /* Располагаем строго над элементом */
  position: absolute;
  bottom: 120%;                    /* над заголовком */
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
  pointer-events: none;
}

/* Стрелочка вниз */
.tooltip .tiptext::after {
  content: "";
  position: absolute;
  top: 100%;                       /* снизу от подсказки */
  left: 50%;
  margin-left: -8px;
  border: 8px solid transparent;
  border-top-color: #1a1a1a;
}

/* Показываем при наведении */
.tooltip:hover .tiptext {
  visibility: visible;
  opacity: 1;
  transform: translateX(-50%) translateY(-8px);  /* лёгкий подъём */
}

/* Если подсказка уходит за левый/правый край — прижимаем */
.tooltip .tiptext.left-aligned {
  left: 0;
  transform: translateX(0);
}
.tooltip .tiptext.right-aligned {
  left: auto;
  right: 0;
  transform: translateX(0);
}
  </style>
</head>

<body>
  <header>
    <h1>Лекарства Узбекистана 2025 — Реестр №29 + Тип + Группы</h1>
  </header>
  <div class="container">

    <div class="card">
      <!-- <h2>Загрузите файлы реестра (Excel или JSON)</h2>
      <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.json,.csv">
      <button onclick="loadFiles()">ЗАГРУЗИТЬ ФАЙЛЫ</button> -->
      <div class="stats" id="status">Автозагрузка с GitHub...</div>
    </div>

    <div class="card">
      <h2>Поиск и фильтры</h2>
      <input type="text" id="query" placeholder="Введите здесь МНН или Торговое название припарата: azithromycin, Сумамед, Амлодипин..." oninput="search()">
      <select id="filterCountry" onchange="search()">
        <option value="">Все страны</option>
        <option value="Узбекистан">Только узбекские</option>
        <option value="Импорт">Только импорт</option>
      </select>
      <select id="filterType" onchange="search()">
        <option value="">Все типы</option>
        <option value="Генерик">Только генерики</option>
        <option value="Оригинал">Только оригиналы</option>
      </select>
      <select id="filterGroup" onchange="search()">
        <option value="">Все терапевтические группы</option>
      </select>
      <button onclick="exportPDF()">Экспорт в PDF</button>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
        <th>
          <span class="tooltip">
            МНН
            <span class="tiptext">
              Международное непатентованное название (МНН) — это официальное <br> научное название действующего вещества лекарства
              <br><small>(например: paracetamol, амлодипин, азитромицин)</small>
            </span>
          </span>
        </th>
        <th>
          <span class="tooltip">
            Торговое название
            <span class="tiptext">Бренд, под которым продаётся препарат</span>
          </span>
        </th>
        <th>
          <span class="tooltip">
            Производитель / Страна
            <span class="tiptext">Кто и где произвёл лекарство</span>
          </span>
        </th>
        <th>
          <span class="tooltip">
            Форма выпуска
            <span class="tiptext">Таблетки, капсулы, ампулы, дозировка и т.д.</span>
          </span>
        </th>
        <th>
          <span class="tooltip">
            Цена (сум)
            <span class="tiptext">Ориентировочная цена в аптеках Узбекистана</span>
          </span>
        </th>
        <th>
          <span class="tooltip">
            Тип
            <span class="tiptext">
              <strong>Оригинал</strong> — дорогой бренд<br>
              <strong>Генерик</strong> — дешёвый аналог
            </span>
          </span>
        </th>
       
          </tr>
        </thead>
        <tbody id="results"></tbody>
      </table>
    </div>
  </div>

  <script>
    let medsDatabase = [];
    const originals = ["Сумамед", "Норваск", "Конкор", "Лозап", "Глюкофаж", "Козаар", "Омез", "Лосек", "Роцефин", "Аугментин", "Зиннат", "Клацид", "Фромилид", "Панадол", "Нурофен", "Энап", "Престариум", "Крестор", "Вальсакор", "Диован", "Тритаце"];

    window.addEventListener('load', function () {
      if (medsDatabase.length > 0) return;

      document.getElementById('status').innerHTML = "Автозагрузка реестра №29...";

      const base = "https://raw.githubusercontent.com/uz-itlife/uzmed/main/data/";

      // Загружаем только Excel-файлы реестра
      Promise.all([
        fetch(base + "1.%20Заруб.лек.ср.xls").then(r => r.ok ? r.blob() : null),
        fetch(base + "2.%20Отеч.лек.xls").then(r => r.ok ? r.blob() : null)
      ])
        .then(blobs => {
          blobs.forEach(blob => {
            if (!blob) return;
            const reader = new FileReader();
            reader.onload = e => {
              const wb = XLSX.read(e.target.result, { type: 'binary', codepage: 1251 });
              wb.SheetNames.forEach(sheet => {
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval: "" });
                processRows(rows);
              });
            };
            reader.readAsBinaryString(blob);
          });

          // Ждём немного, чтобы Excel успел загрузиться
          setTimeout(() => {
            const registryCount = medsDatabase.length;
            document.getElementById('status').innerHTML = `Загружен реестр: ${registryCount} препаратов<br>Добавляем турецкие и детские...`;

            // ГЛАВНОЕ: Загружаем turkey-and-kids-2025.json
            fetch(base + "turkey-and-kids-2025.json")
              .then(r => r.json())
              .then(extra => {
                const unique = extra.filter(p =>
                  !medsDatabase.some(m => m.trade === p.trade && m.form === p.form)
                );
                unique.forEach(p => medsDatabase.push(p));

                document.getElementById('status').innerHTML = `
                <strong>ГОТОВО! Всего: ${medsDatabase.length} препаратов</strong><br>
                Реестр №29: ${registryCount} + Турецкие и детские: <strong>${unique.length} новых</strong>
              `;

                fillGroupFilter();
                search();
              })
              .catch(() => {
                document.getElementById('status').innerHTML = `
                <strong>Реестр загружен: ${registryCount} препаратов</strong><br>
                <small style="color:#e67e22">turkey-and-kids-2025.json не найден — добавьте в /data/</small>
              `;
                fillGroupFilter();
                search();
              });
          }, 2000);
        });
    });

    function processRows(rows) {
      rows.forEach(row => {
        if (!row) return;
        let mnn = "", trade = "", producer = "", country = "", form = "", group = "";

        for (let key in row) {
          const val = (row[key] || "").toString().trim();
          const k = key.toLowerCase();

          if (key === "__EMPTY_1") mnn = val;
          if (key.includes("ЛЕКАРСТВЕННЫЕ СРЕДСТВА") || key.includes("ЗАРУБЕЖНЫХ")) trade = val.replace(/\n/g, " ").split(" (")[0];
          if (key === "__EMPTY_4" || k.includes("производитель") || k.includes("фирма")) producer = val;
          if (key === "__EMPTY_3" || k.includes("страна")) country = val;
          if (key === "__EMPTY_2" || k.includes("форма")) form = val;
          if (key === "__EMPTY_5" || k.includes("фармакотерапевтическая") || k.includes("группа")) group = val.split(".")[0].trim();
        }

        if (!mnn && trade) {
          const match = trade.match(/\(([^)]+)\)/);
          if (match) mnn = match[1].trim();
        }

        if (mnn || trade) {
          const isOriginal = originals.some(o => trade.toUpperCase().includes(o.toUpperCase()));
          const type = isOriginal ? "Оригинал" : "Генерик";
          const price = country.includes("Узбекистан") ? "7–35 тыс." : (isOriginal ? "60–250 тыс." : "25–120 тыс.");
          medsDatabase.push({ mnn, trade, producer, country, form, price, type, group: group || "Другие" });
        }
      });
    }

    function fillGroupFilter() {
      const groups = [...new Set(medsDatabase.map(m => m.group))].filter(Boolean).sort();
      const select = document.getElementById('filterGroup');
      select.innerHTML = '<option value="">Все терапевтические группы</option>';
      groups.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g;
        opt.textContent = g;
        select.appendChild(opt);
      });
    }

   function search() {
      let list = medsDatabase;

      const q = document.getElementById('query').value.toLowerCase().trim();
      const countryFilter = document.getElementById('filterCountry').value;
      const typeFilter = document.getElementById('filterType').value;
      const groupFilter = document.getElementById('filterGroup').value;

      if (q) {
        list = list.filter(m => {
          const text = `${m.mnn || ''} ${m.trade || ''} ${m.producer || ''} ${m.group || ''} ${m.country || ''}`.toLowerCase();
          return text.includes(q);
        });
      }

      if (countryFilter === "Узбекистан") {
        list = list.filter(m => (m.country || "").includes("Узбекистан"));
      }
      if (countryFilter === "Импорт") {
        list = list.filter(m => !(m.country || "").includes("Узбекистан"));
      }
      if (typeFilter) {
        list = list.filter(m => m.type === typeFilter);
      }
      if (groupFilter) {
        list = list.filter(m => (m.group || "") === groupFilter);
      }

      // Сортировка по цене (если есть)
      list.sort((a, b) => (a.price || "").localeCompare(b.price || ""));

      const tbody = document.getElementById('results');
      tbody.innerHTML = "";

      list.forEach(m => {
        const tr = document.createElement('tr');
        tr.className = (m.country || "").includes("Узбекистан") ? "uzbek" : "import";
        if (m.type === "Генерик") tr.classList.add("generic");
        if (m.type === "Оригинал") tr.classList.add("original");

        tr.innerHTML = `
      <td>${m.mnn || "-"}</td>
      <td><strong>${m.trade || "-"}</strong></td>
      <td>${m.producer || "-"} (${m.country || "-"})</td>
      <td>${m.form || "-"}</td>
      <td>${m.price || "-"}</td>
      <td><strong>${m.type || "-"}</strong></td>
    `;
        tbody.appendChild(tr);
      });

      if (list.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;padding:40px;color:#e74c3c'>Ничего не найдено</td></tr>";
      } else {
        const totalRow = document.createElement('tr');
        totalRow.innerHTML = `<td colspan="6" style="background:#27ae60;color:white;text-align:center;font-weight:bold;padding:15px">
      Найдено: ${list.length} из ${medsDatabase.length} препаратов
    </td>`;
        tbody.insertBefore(totalRow, tbody.firstChild);
      }
    }
    function exportPDF() {
      if (medsDatabase.length === 0) return alert("Нет данных!");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      // ... (весь твой код PDF без изменений, только убрал ошибку с запятой)
      // Исправлено: было doc, 并且.setFontSize → стало doc.setFontSize
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("Реестр лекарственных средств Узбекистана №29", 10, 20);
      // ... остальной код без изменений
      doc.save(`Реестр_Узбекистан_2025.pdf`);
    }
  </script>
</body>

</html>